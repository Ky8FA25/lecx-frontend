@if (loading()) {
  <div class="container-fluid">
    <div class="d-flex align-items-center justify-content-center" style="height: 100vh;">
      <div class="spinner-border" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
    </div>
  </div>
} @else if (lecture()) {
  @let currentLecture = lecture()!;
  
  <div class="container-fluid">
    <!-- Page Heading -->
    <h1 class="h3 mb-2 text-gray-800 d-flex align-items-center">
      {{ currentLecture.title }}
      
      <div class="dropdown ml-auto">
        <button
          class="btn"
          type="button"
          id="dropdownMenuButton"
          [attr.data-bs-toggle]="'dropdown'"
          aria-expanded="false"
        >
          <i class="fas fa-cog"></i>
        </button>
        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdownMenuButton">
          <li class="mb-2">
            <button 
              class="dropdown-item" 
              (click)="markAsCompleted()"
              [disabled]="markingCompleted()">
              @if (markingCompleted()) {
                <span class="spinner-border spinner-border-sm me-2" role="status"></span>
              }
              @if (isCompleted()) {
                Unmark as completed
              } @else {
                Mark as completed
              }
            </button>
          </li>
          <li>
            <a
              class="dropdown-item text-danger"
              (click)="openReportModal(); $event.preventDefault()"
              style="cursor: pointer;">
              Report Lecture <i class="far fa-flag ms-2"></i>
            </a>
          </li>
        </ul>
      </div>
    </h1>

    <p class="mb-4">
      {{ currentLecture.description }}
    </p>

    <div class="row">
      <div class="col-xl-8 col-lg-7">
        <div class="card shadow mb-4">
          <!-- Video Section -->
          @if (getVideoFiles().length > 0) {
            @let videoFile = getVideoFiles()[0];
            <div class="position-relative">
              <video class="card-img-top" controls style="height: 100%; width: 100%">
                <source [src]="videoFile.filePath" [type]="'video/' + videoFile.fileExtension" />
                Your browser does not support the video tag.
              </video>
            </div>
          } @else {
            <div class="card-img-top d-flex align-items-center justify-content-center bg-light" style="height: 400px;">
              <p class="text-muted">No video available</p>
            </div>
          }

          <div class="m-3">
            <h5>Documents</h5>

            @if (getDocumentFiles().length > 0) {
              @for (file of getDocumentFiles(); track file.fileId) {
                <div class="position-relative mb-2">
                  <i class="fas fa-file-alt me-2 ms-2"></i>
                  <a 
                    [href]="file.filePath" 
                    class="btn-link" 
                    target="_blank"
                    (click)="$event.stopPropagation()">
                    {{ file.fileName }}
                  </a>
                </div>
              }
            } @else {
              <div class="position-relative m-1">
                <p class="text-muted">No documents yet.</p>
              </div>
            }

            <div class="d-flex gap-2 mt-3">
              <button 
                class="btn p-3 ml-auto"
                [class.btn-completed]="isCompleted()"
                [class.btn-outline-primary]="!isCompleted()"
                (click)="markAsCompleted()"
                [disabled]="markingCompleted()">
                @if (markingCompleted()) {
                  <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                } @else {
                  <i class="fas fa-check-circle mr-1"></i>
                }
                @if (isCompleted()) {
                  Marked as completed
                } @else {
                  Mark as completed
                }
              </button>

              @if (hasNextLecture()) {
                <button 
                  class="btn btn-outline-black p-3 ml-auto"
                  (click)="goToNextLecture()">
                  Go to next lecture
                </button>
              }
            </div>
          </div>
        </div>

        <!-- Navigation Buttons -->
        <div class="d-flex justify-content-between mt-3 mb-5">
          <button 
            class="btn btn-outline-black"
            [disabled]="!hasPreviousLecture()"
            (click)="goToPreviousLecture()">
            <i class="fas fa-chevron-left mr-2"></i>Previous
          </button>

          <button 
            class="btn btn-outline-black"
            [disabled]="!hasNextLecture()"
            (click)="goToNextLecture()">
            Next <i class="fas fa-chevron-right ml-1"></i>
          </button>
        </div>
      </div>

      <!-- Discussion Section -->
      <div class="col-xl-4 col-lg-5">
        <div class="card shadow mb-4">
          <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-info">Discussion</h6>
          </div>

          <div class="card-body position-relative" style="height: 400px; overflow-y: auto">
            <!-- Comment list -->
            <div class="comment-list">
              <p class="text-muted">Discussion feature coming soon...</p>
            </div>

            <!-- Comment input -->
            <div
              class="border-top p-2 bg-white w-100"
              style="position: absolute; bottom: 0px; z-index: 1; left: 0"
            >
              <form class="input-group d-flex align-items-end">
                <label
                  for="file-upload"
                  class="btn btn-info mr-2 m-0 d-flex align-items-center"
                  style="border-radius: 20px; height: 40px">
                  <i class="bi bi-plus-lg"></i>
                </label>
                <input
                  type="file"
                  id="file-upload"
                  class="d-none"
                  accept=".pdf,.doc,.docx,.ppt,.pptx, image/*"
                  multiple
                />

                <textarea
                  class="form-control"
                  placeholder="Write your comment"
                  rows="1"
                  style="border-radius: 20px; resize: none"
                  required
                ></textarea>

                <button
                  type="submit"
                  class="btn btn-info ml-2"
                  style="border-radius: 20px; height: 40px"
                  disabled>
                  <i class="bi bi-send-fill"></i>
                </button>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Report Modal -->
  @if (showReportModal()) {
    <div class="modal" style="display: block;" (click)="closeReportModal()">
      <div class="modal-dialog" (click)="$event.stopPropagation()">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Report Lecture</h5>
            <button type="button" class="btn-close" (click)="closeReportModal()"></button>
          </div>

          <div class="modal-body">
            <form>
              <p>Please select the reason for reporting this lecture:</p>

              <div class="form-check">
                <input
                  class="form-check-input"
                  type="radio"
                  name="Reason"
                  id="reason1"
                  value="Inappropriate content"
                  required
                />
                <label class="form-check-label" for="reason1">Inappropriate content</label>
              </div>

              <div class="form-check">
                <input
                  class="form-check-input"
                  type="radio"
                  name="Reason"
                  id="reason2"
                  value="Misleading information"
                  required
                />
                <label class="form-check-label" for="reason2">Misleading information</label>
              </div>

              <div class="form-check">
                <input
                  class="form-check-input"
                  type="radio"
                  name="Reason"
                  id="reason3"
                  value="Copyright infringement"
                  required
                />
                <label class="form-check-label" for="reason3">Copyright infringement</label>
              </div>

              <div class="form-check">
                <input
                  class="form-check-input"
                  type="radio"
                  name="Reason"
                  id="otherReason"
                  value="Other"
                  required
                />
                <label class="form-check-label" for="otherReason">Other</label>
              </div>

              <div class="mt-3">
                <label for="otherReasonText" class="form-label">Please specify:</label>
                <textarea
                  class="form-control"
                  name="OtherReason"
                  id="otherReasonText"
                  rows="3"
                  readonly
                  required
                ></textarea>
              </div>

              <div class="mt-3 text-end">
                <button type="button" class="btn custom-btn me-1" (click)="closeReportModal()">
                  Cancel
                </button>
                <button type="submit" class="btn custom-btn" disabled>Submit Report</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  }
} @else {
  <div class="container-fluid">
    <div class="d-flex align-items-center justify-content-center" style="height: 100vh;">
      <h5 class="text-muted">Lecture not found</h5>
    </div>
  </div>
}
